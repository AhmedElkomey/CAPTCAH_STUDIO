name: "ğŸš€ CAPTCHA Studio â€” Build & Release"

on:
  push:
    branches: [main, master]
    tags: ["v*"]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 1: Build the Windows Executable
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    name: "Build (Windows)"
    runs-on: windows-latest
    outputs:
      artifact-name: ${{ steps.meta.outputs.artifact_name }}

    steps:
      - name: "ğŸ“¥ Checkout source"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0    # needed for tag-based release notes

      - name: "ğŸ Set up Python 3.11"
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: "ğŸ“¦ Install dependencies"
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: "ğŸ”¨ Build with PyInstaller"
        run: >
          python -m PyInstaller
          --noconfirm
          --onedir
          --windowed
          --noconsole
          --name "CAPTCHA_Studio"
          --hidden-import PIL
          --hidden-import cv2
          --hidden-import numpy
          --add-data "ui;ui"
          app.py

      - name: "ğŸ“ Compute artifact name"
        id: meta
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}" -replace "^v", ""
          $name = "CAPTCHA_Studio-Windows-$version"
          echo "artifact_name=$name" >> $env:GITHUB_OUTPUT

      - name: "ğŸ—œ Compress build"
        shell: pwsh
        run: |
          Compress-Archive `
            -Path dist/CAPTCHA_Studio `
            -DestinationPath "dist/${{ steps.meta.outputs.artifact_name }}.zip" `
            -Force

      - name: "ğŸ’¾ Upload build artifact"
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.meta.outputs.artifact_name }}
          path: "dist/${{ steps.meta.outputs.artifact_name }}.zip"
          retention-days: 7

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 2: Build the Linux Executable
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-linux:
    name: "Build (Linux)"
    runs-on: ubuntu-latest
    outputs:
      artifact-name: ${{ steps.meta.outputs.artifact_name }}

    steps:
      - name: "ğŸ“¥ Checkout source"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "ğŸ§ Install system dependencies"
        run: |
          sudo apt-get update
          sudo apt-get install -y libglib2.0-0 libsm6 libxext6 libxrender-dev libgl1-mesa-glx python3-opencv

      - name: "ğŸ Set up Python 3.11"
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: "ğŸ“¦ Install dependencies"
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: "ğŸ”¨ Build with PyInstaller"
        run: >
          python -m PyInstaller
          --noconfirm
          --onedir
          --windowed
          --name "CAPTCHA_Studio"
          --hidden-import PIL
          --hidden-import cv2
          --hidden-import numpy
          --add-data "ui:ui"
          app.py

      - name: "ğŸ“ Compute artifact name"
        id: meta
        run: |
          version="${GITHUB_REF_NAME#v}"
          name="CAPTCHA_Studio-Linux-$version"
          echo "artifact_name=$name" >> $GITHUB_OUTPUT

      - name: "ğŸ—œ Compress build"
        run: |
          cd dist
          tar -czvf "${{ steps.meta.outputs.artifact_name }}.tar.gz" CAPTCHA_Studio

      - name: "ğŸ’¾ Upload build artifact"
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.meta.outputs.artifact_name }}
          path: "dist/${{ steps.meta.outputs.artifact_name }}.tar.gz"
          retention-days: 7

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 3: Publish GitHub Release (runs only on version tags)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  release:
    name: "Publish Release"
    needs: [build, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - name: "ğŸ“¥ Checkout source"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "â¬‡ï¸ Download Windows build artifact"
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact-name }}
          path: release-assets

      - name: "â¬‡ï¸ Download Linux build artifact"
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build-linux.outputs.artifact-name }}
          path: release-assets

      - name: "ğŸš€ Create GitHub Release"
        uses: softprops/action-gh-release@v2
        with:
          name: "CAPTCHA Studio ${{ github.ref_name }}"
          tag_name: ${{ github.ref_name }}
          prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') || contains(github.ref_name, 'rc') }}
          generate_release_notes: true
          body: |
            ## ğŸ“¦ Download

            | Asset | Platform | Notes |
            |-------|----------|-------|
            | `CAPTCHA_Studio-Windows-*.zip` | Windows 10/11 x64 | No Python required â€” extract & run |
            | `CAPTCHA_Studio-Linux-*.tar.gz` | Linux x64 | No Python required â€” extract & run |

            ## ğŸš€ Quick Start
            1. Download and extract the archive for your OS.
            2. Run `CAPTCHA_Studio.exe` (Windows) or `./CAPTCHA_Studio` (Linux) inside the extracted folder.
            3. Use the **Annotator** tab to label images and the **Generator** tab to synthesise new CAPTCHAs.

            ## ğŸ“‹ What's Changed
            <!-- GitHub automatically appends the auto-generated changelog below -->
          files: release-assets/*
