name: "ğŸš€ CAPTCHA Studio â€” Build & Release"

on:
  push:
    branches: [main, master]
    tags: ["v*"]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 1: Build the Windows Executable
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    name: "Build (Windows)"
    runs-on: windows-latest
    timeout-minutes: 30
    outputs:
      artifact-name: ${{ steps.meta.outputs.artifact_name }}

    steps:
      - name: "ğŸ“¥ Checkout source"
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: "ğŸ Set up Python 3.11"
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: "ğŸ“¦ Install dependencies"
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: "âœ… Syntax check"
        run: |
          python -m compileall -q app.py main.py generator.py bg_gen.py ui

      - name: "ğŸ”¨ Build with PyInstaller"
        run: >
          python -m PyInstaller
          --noconfirm
          --onedir
          --windowed
          --noconsole
          --name "CAPTCHA_Studio"
          --hidden-import PIL
          --hidden-import cv2
          --hidden-import numpy
          --add-data "ui;ui"
          app.py

      - name: "ğŸ“ Compute artifact name"
        id: meta
        shell: pwsh
        run: |
          if ($env:GITHUB_REF_TYPE -eq "tag") {
            $raw = $env:GITHUB_REF_NAME -replace "^v", ""
          } elseif ($env:GITHUB_EVENT_NAME -eq "pull_request" -and $env:GITHUB_REF -match "^refs/pull/(\d+)/") {
            $raw = "pr-$($Matches[1])"
          } else {
            $shortSha = if ($env:GITHUB_SHA.Length -ge 7) { $env:GITHUB_SHA.Substring(0, 7) } else { $env:GITHUB_SHA }
            $raw = "sha-$shortSha"
          }
          $safe = ($raw -replace "[^0-9A-Za-z._-]", "-").Trim("-")
          if ([string]::IsNullOrWhiteSpace($safe)) {
            $safe = "dev"
          }
          $name = "CAPTCHA_Studio-Windows-$safe"
          echo "artifact_name=$name" >> $env:GITHUB_OUTPUT

      - name: "ğŸ—œ Compress build"
        shell: pwsh
        run: |
          Compress-Archive `
            -Path dist/CAPTCHA_Studio `
            -DestinationPath "dist/${{ steps.meta.outputs.artifact_name }}.zip" `
            -Force

      - name: "ğŸ’¾ Upload build artifact"
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.meta.outputs.artifact_name }}
          path: "dist/${{ steps.meta.outputs.artifact_name }}.zip"
          retention-days: 7

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 2: Build the Linux Executable
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-linux:
    name: "Build (Linux)"
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      artifact-name: ${{ steps.meta.outputs.artifact_name }}

    steps:
      - name: "ğŸ“¥ Checkout source"
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: "ğŸ§ Install system dependencies"
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends libglib2.0-0 libsm6 libxext6 libxrender1 libgl1

      - name: "ğŸ Set up Python 3.11"
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: "ğŸ“¦ Install dependencies"
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: "âœ… Syntax check"
        run: |
          python -m compileall -q app.py main.py generator.py bg_gen.py ui

      - name: "ğŸ”¨ Build with PyInstaller"
        run: >
          python -m PyInstaller
          --noconfirm
          --onedir
          --windowed
          --name "CAPTCHA_Studio"
          --hidden-import PIL
          --hidden-import cv2
          --hidden-import numpy
          --add-data "ui:ui"
          app.py

      - name: "ğŸ“ Compute artifact name"
        id: meta
        run: |
          if [[ "${GITHUB_REF_TYPE:-}" == "tag" ]]; then
            raw="${GITHUB_REF_NAME#v}"
          elif [[ "${GITHUB_EVENT_NAME}" == "pull_request" && "${GITHUB_REF}" =~ ^refs/pull/([0-9]+)/ ]]; then
            raw="pr-${BASH_REMATCH[1]}"
          else
            raw="sha-${GITHUB_SHA::7}"
          fi
          safe="$(echo "$raw" | sed -E 's/[^0-9A-Za-z._-]+/-/g; s/^-+//; s/-+$//')"
          if [[ -z "$safe" ]]; then
            safe="dev"
          fi
          name="CAPTCHA_Studio-Linux-$safe"
          echo "artifact_name=$name" >> $GITHUB_OUTPUT

      - name: "ğŸ—œ Compress build"
        run: |
          cd dist
          tar -czvf "${{ steps.meta.outputs.artifact_name }}.tar.gz" CAPTCHA_Studio

      - name: "ğŸ’¾ Upload build artifact"
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.meta.outputs.artifact_name }}
          path: "dist/${{ steps.meta.outputs.artifact_name }}.tar.gz"
          retention-days: 7

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 3: Publish GitHub Release (runs only on version tags)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  release:
    name: "Publish Release"
    needs: [build, build-linux]
    runs-on: ubuntu-latest
    if: always()
    timeout-minutes: 15
    permissions:
      contents: write

    steps:
      - name: "ğŸ” Evaluate release conditions"
        id: gate
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${GITHUB_EVENT_NAME}" == "push" && "${GITHUB_REF}" == refs/tags/v* ]]; then
            echo "should_release=true" >> "$GITHUB_OUTPUT"
            echo "tag_name=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
            echo "Version tag detected: ${GITHUB_REF_NAME}"
          else
            echo "should_release=false" >> "$GITHUB_OUTPUT"
            echo "This run is not a version-tag push. Release publishing is skipped by design."
          fi

      - name: "ğŸ§ª Validate build prerequisites"
        if: steps.gate.outputs.should_release == 'true'
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ needs.build.result }}" != "success" || "${{ needs.build-linux.result }}" != "success" ]]; then
            echo "Windows build result: ${{ needs.build.result }}"
            echo "Linux build result: ${{ needs.build-linux.result }}"
            echo "Cannot publish release because one or more prerequisite builds failed."
            exit 1
          fi

      - name: "â¬‡ï¸ Download Windows build artifact"
        if: steps.gate.outputs.should_release == 'true'
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact-name }}
          path: release-assets

      - name: "â¬‡ï¸ Download Linux build artifact"
        if: steps.gate.outputs.should_release == 'true'
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build-linux.outputs.artifact-name }}
          path: release-assets

      - name: "ğŸš€ Create GitHub Release"
        if: steps.gate.outputs.should_release == 'true'
        uses: softprops/action-gh-release@v2
        with:
          name: "CAPTCHA Studio ${{ steps.gate.outputs.tag_name }}"
          tag_name: ${{ steps.gate.outputs.tag_name }}
          prerelease: ${{ contains(steps.gate.outputs.tag_name, 'beta') || contains(steps.gate.outputs.tag_name, 'alpha') || contains(steps.gate.outputs.tag_name, 'rc') }}
          generate_release_notes: true
          body: |
            ## ğŸ“¦ Download

            | Asset | Platform | Notes |
            |-------|----------|-------|
            | `CAPTCHA_Studio-Windows-*.zip` | Windows 10/11 x64 | No Python required â€” extract & run |
            | `CAPTCHA_Studio-Linux-*.tar.gz` | Linux x64 | No Python required â€” extract & run |

            ## ğŸš€ Quick Start
            1. Download and extract the archive for your OS.
            2. Run `CAPTCHA_Studio.exe` (Windows) or `./CAPTCHA_Studio` (Linux) inside the extracted folder.
            3. Use the **Annotator** tab to label images and the **Generator** tab to synthesise new CAPTCHAs.

            ## ğŸ“‹ What's Changed
            <!-- GitHub automatically appends the auto-generated changelog below -->
          files: |
            release-assets/*.zip
            release-assets/*.tar.gz
